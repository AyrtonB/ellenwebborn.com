---
layout: post
title: Imputed covariance matrices for meta-analysis of correlated effects
date: August 9, 2017
tags: [meta-analysis, sandwiches, R, programming]
---


```{r}
library(dplyr)
data(SATcoaching, package = "clubSandwich")

mean_hrs_ln <- 
  SATcoaching %>% 
  group_by(study) %>%
  summarise(hrs_ln = mean(log(hrs))) %>%
  summarise(hrs_ln = mean(hrs_ln, na.rm = TRUE))

SATcoaching <- 
  SATcoaching %>%
  # clean variables
  mutate(
    study = as.factor(study),
    hrs_ln = log(hrs) - mean_hrs_ln$hrs_ln
  ) %>%
  # sort by study ID
  arrange(study, test)


SATcoaching %>%
  select(study, year, test, d, V, hrs_ln) %>%
  head(n = 20)
```

```{r}
V_list <- with(SATcoaching, impute_covariance_matrix(vi = V, cluster = study, r = 0.66))
```

```{r}
library(metafor)

# bivariate fixed effect meta-analysis
MVFE_null <- rma.mv(d ~ 0 + test, V = V_list, data = SATcoaching)
MVFE_null

# bivariate fixed effect meta-regression
MVFE_hrs <- rma.mv(d ~ 0 + test + test:hrs_ln, V = V_list, data = SATcoaching)
MVFE_hrs

# bivariate random effects meta-analysis
MVRE_null <- rma.mv(d ~ 0 + test, V = V_list, data = SATcoaching, 
                 random = ~ test | study, struct = "UN")
MVRE_null

# bivariate random effects meta-regression
MVRE_hrs <- rma.mv(d ~ 0 + test + test:hrs_ln, V = V_list, data = SATcoaching, 
                 random = ~ test | study, struct = "UN")
MVRE_hrs

```

## A note on robust variance estimation.

An alternative strategy to the ones described above is to use robust variance estimation methods (RVE; [Hedges, Tipton, & Johnson](https://dx.doi.org/10.1002/jrsm.5)), as implemented for instance in the [robumeta R package](https://CRAN.R-project.org/package=robumeta). RVE isn't strictly an alternative to the strategies listed above because it is only a variance estimation technique, not necessarily a full modeling strategy. However, the RVE implementation in `robumeta` combines a) a moment estimator for a certain random effects structure, b) a weighting strategy, and c) robust methods for estimating standard errors/hypothesis tests/confidence intervals for meta-regression coefficients. Like the strategy described above, RVE (with a correlated effects model) involves imputing a correlation between effect size estimates from each study, and using this correlation for further aspects of model estimation. From the user's perspective, the main difference would appear to be that robumeta does all the calculations "under the hood," whereas I had to calculate the variance-covariance matrix before fitting the model. Here is how the bivariate random effects meta-regression can be fit using `robumeta`:

```{r}
library(robumeta)
robu(d ~ 0 + test + test:hrs_ln, 
     data = filter(SATcoaching, !is.na(hrs_ln)),
     studynum = study, var.eff.size = V, 
     modelweights = "CORR", rho = 0.66)
```

